<!-- pages/profile/index.wxml -->

<!-- ç”¨æˆ·å¡ç‰‡ -->
<profile-card user="{{user}}" bind:chooseAvatarTap="changeAvatar" bind:posterTap="changePoster" />

<!-- æ¶ˆæ¯èƒ¶å›Š -->
<view wx:if="{{messageBrief}}" class="msg-capsule" bindtap="gotoMessage">
  <avatar src="{{messageBrief[0].action_user.avatar}}" isLink="{{false}}" />
  <text class="msg-tip">{{messageBrief.length < 99 ? messageBrief.length : '99+' }}æ¡æ–°åŠ¨æ€</text>
</view>

<!-- TABæ  -->
<l-tabs id="tabs" l-header-class="tabs {{tabsFixed ? 'tabs-fixed' : ''}}" l-line-class="tabs-line" animated animated-for-line active-color="#337559" bind:linchange="changeTabs">
  <l-tabpanel tab="è¯é¢˜" key="topic" slot="topic">
    <view style="{{tabsFixed ? 'margin-top: 80rpx;' : ''}}">
      <nothing wx:if="{{topics.length === 0}}" nothing-class="{{messageBrief ? 'nothing-message' : 'nothing'}}" pic="../../images/icon_nothing/pic_topic.png" tip="ä½ è¿˜æ²¡æœ‰å‘å¸ƒè¯é¢˜" />
      <profile-topic topics="{{topics}}" isOwner bind:deleteTap="deleteTopic" />
      <l-loadmore show="{{!hasMoreTopic && topics.length > 0}}" line type="end" end-text="å·²ç»åˆ°åº•äº†" />
    </view>
  </l-tabpanel>
  <l-tabpanel tab="è¯„è®º" key="comment" slot="comment">
    <view style="{{tabsFixed ? 'margin-top: 80rpx;' : ''}}">
      <nothing wx:if="{{comments.length === 0}}" nothing-class="{{messageBrief ? 'nothing-message' : 'nothing'}}" pic="../../images/icon_nothing/pic_comment.png" tip="ä½ è¿˜æ²¡æœ‰å‘è¡¨è¯„è®º" />
      <profile-comment comments="{{comments}}" isOwner bind:deleteTap="deleteComment" />
      <l-loadmore show="{{!hasMoreComment && comments.length > 0}}" line type="end" end-text="å·²ç»åˆ°åº•äº†" />
    </view>
  </l-tabpanel>
  <l-tabpanel tab="æ”¶è—" key="star" slot="star">
    <view style="{{tabsFixed ? 'margin-top: 80rpx;' : ''}}">
      <nothing wx:if="{{stars.length === 0}}" nothing-class="{{messageBrief ? 'nothing-message' : 'nothing'}}" pic="../../images/icon_nothing/pic_star.png" tip="ä½ è¿˜æ²¡æœ‰æ”¶è—è¯é¢˜" />
      <profile-star stars="{{stars}}" isOwner bind:deleteTap="deleteStar" />
      <l-loadmore show="{{!hasMoreStar && stars.length > 0}}" line type="end" end-text="å·²ç»åˆ°åº•äº†" />
    </view>
  </l-tabpanel>
</l-tabs>

<!-- å›¾ç‰‡è£å‰ªå™¨ -->
<l-image-clipper lock-width lock-height limit-move min-ratio="1" show="{{showImageClipper}}" image-url="{{tmpAvatar}}" bindlinclip="onClipTap" />

<!-- åŠ è½½æ•°æ®æç¤º -->
<l-loadmore show="{{loading}}" line type="loading" loading-text="æ­£åœ¨åŠ è½½ä¸­..." />

<!-- æ¶ˆæ¯å¯¹è¯æ¡† -->
<l-dialog id="dialog" />

<!-- æ¶ˆæ¯æç¤º -->
<l-message />

<!-- cocobegin -->
<!-- å·§å…‹åŠ›ç½æµ®åŠ¨æŒ‰é’® -->
<view class="chocolate-jar-btn" bindtap="openSoulMessage">
  <image class="chocolate-jar-icon" src="../../images/icon_chocolate.png" mode="aspectFit" />
</view>

<!-- å¿ƒçµé¸¡æ±¤å¼¹çª— -->
<l-popup show="{{showSoulPopup}}" bind:linclose="closeSoulPopup" position="center" width="600rpx">
  <view class="soul-popup">
    <!-- Tabåˆ‡æ¢ï¼šæŸ¥çœ‹/æ·»åŠ  -->
    <view class="soul-tabs">
      <view class="soul-tab {{soulTabIndex === 0 ? 'active' : ''}}" bindtap="switchSoulTab" data-index="0">æŸ¥çœ‹</view>
      <view class="soul-tab {{soulTabIndex === 1 ? 'active' : ''}}" bindtap="switchSoulTab" data-index="1">æ·»åŠ </view>
    </view>

    <!-- æŸ¥çœ‹æ¨¡å¼ -->
    <view wx:if="{{soulTabIndex === 0}}" class="soul-view">
      <view class="soul-title">ğŸ« å·§å…‹åŠ›ç½</view>
      <!-- æ˜¾ç¤ºæ™ºèƒ½è¯†åˆ«å‡ºçš„æƒ…ç»ªæ ‡ç­¾ -->
      <view wx:if="{{soulMessage.emotion_label && soulMessage.emotion_label.name}}" class="soul-emotion-info">
        <view class="soul-emotion-header">
          <text class="soul-emotion-label-text">æ™ºèƒ½è¯†åˆ«åˆ°çš„æƒ…ç»ª</text>
        </view>
        <view class="soul-emotion-badge" style="background-color: {{soulMessage.emotion_label.color}}15; border-color: {{soulMessage.emotion_label.color}};">
          <text class="soul-emotion-icon">{{soulMessage.emotion_label.icon || 'ğŸ­'}}</text>
          <text class="soul-emotion-name" style="color: {{soulMessage.emotion_label.color}};">{{soulMessage.emotion_label.name}}</text>
        </view>
        <view wx:if="{{soulMessage.confidence}}" class="soul-confidence-info">
          <text class="soul-confidence-label">ç®—æ³•è¯†åˆ«åŒ¹é…åº¦ï¼š</text>
          <text class="soul-confidence-value" style="color: {{soulMessage.emotion_label.color}};">{{soulMessage.confidence_percent}}%</text>
        </view>
      </view>
      <view class="soul-content">{{soulMessage.content || ''}}</view>
      <view wx:if="{{soulMessage.push_id}}" class="soul-actions">
        <button class="soul-btn-collect" size="mini" bindtap="collectSoulMessage">{{soulMessage.is_collected ? 'å·²æ”¶è—' : 'æ”¶è—'}}</button>
      </view>
      <view class="soul-actions">
        <button class="soul-btn-random" size="mini" bindtap="getRandomMessage">æ¢ä¸€æ¡</button>
        <button class="soul-btn-view-all" size="mini" bindtap="viewAllMessages">æŸ¥çœ‹å…¨éƒ¨</button>
      </view>
    </view>

    <!-- æ·»åŠ æ¨¡å¼ -->
    <view wx:if="{{soulTabIndex === 1}}" class="soul-add">
      <view class="soul-title">âœ¨ æ·»åŠ å¥å­</view>
      <textarea 
        class="soul-input" 
        placeholder="è¾“å…¥ä½ æƒ³è¦ä¿å­˜çš„å¥å­..."
        value="{{customMessage}}"
        bindinput="onCustomMessageInput"
        maxlength="200"
        auto-height
      />
      <view class="soul-input-tip">è¿˜å¯ä»¥è¾“å…¥ {{200 - customMessage.length}} å­—</view>
      <view class="soul-actions">
        <button class="soul-btn-save" size="mini" type="primary" bindtap="saveCustomMessage">ä¿å­˜</button>
        <button class="soul-btn-cancel" size="mini" bindtap="cancelAddMessage">å–æ¶ˆ</button>
      </view>
    </view>
  </view>
</l-popup>