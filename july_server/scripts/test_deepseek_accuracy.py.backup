#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
æµ‹è¯•DeepSeekæƒ…ç»ªè¯†åˆ«å‡†ç¡®åº¦
æä¾›æµ‹è¯•ç”¨ä¾‹ï¼Œè¯„ä¼°è¯†åˆ«å‡†ç¡®ç‡
"""
import sys
import os
from datetime import datetime

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
script_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(script_dir)
if project_root not in sys.path:
    sys.path.insert(0, project_root)

from app_2 import create_app
from app_2.service.llm_service import LLMService


# æµ‹è¯•ç”¨ä¾‹
TEST_CASES = [
    # (æ–‡æœ¬å†…å®¹, æœŸæœ›æƒ…ç»ª, éš¾åº¦)
    ("ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œå¿ƒæƒ…ä¹Ÿä¸é”™ï¼", "å¼€å¿ƒ", "ç®€å•"),
    ("å·¥ä½œå‹åŠ›å¾ˆå¤§ï¼Œæ€»æ˜¯ç¡ä¸å¥½ï¼Œå¾ˆç„¦è™‘", "ç„¦è™‘", "ç®€å•"),
    ("ä¸€ä¸ªäººåœ¨å®¶ï¼Œæ„Ÿè§‰å¥½å­¤ç‹¬", "å­¤ç‹¬", "ç®€å•"),
    ("æ„Ÿè°¢æœ‹å‹çš„å¸®åŠ©ï¼ŒçœŸçš„å¾ˆæ„ŸåŠ¨", "æ„ŸåŠ¨", "ç®€å•"),
    ("ä»Šå¤©è€ƒè¯•è€ƒå¾—å¾ˆå¥½ï¼Œå¤ªå¼€å¿ƒäº†ï¼", "å¼€å¿ƒ", "ç®€å•"),
    
    ("æœ€è¿‘æ€»æ˜¯æ‹…å¿ƒæœªæ¥ï¼Œæ„Ÿè§‰å‹åŠ›å¾ˆå¤§", "ç„¦è™‘", "ä¸­ç­‰"),
    ("è™½ç„¶å¾ˆç´¯ï¼Œä½†æ˜¯æ„Ÿè§‰å¾ˆå……å®", "å¼€å¿ƒ", "ä¸­ç­‰"),  # è½¬æŠ˜å¥å¼ï¼šè½¬æŠ˜åæ˜¯æƒ…ç»ªï¼ˆå……å®ï¼‰â†’ å¼€å¿ƒ
    ("çœ‹åˆ°åˆ«äººå¹¸ç¦ï¼Œæˆ‘ä¹Ÿæ„Ÿåˆ°å¼€å¿ƒ", "å¼€å¿ƒ", "ä¸­ç­‰"),
    ("è™½ç„¶æœ‰ç‚¹éš¾è¿‡ï¼Œä½†è¿˜æ˜¯è¦åšæŒä¸‹å»", "éš¾è¿‡", "ä¸­ç­‰"),
    
    ("ä»Šå¤©å‘ç”Ÿäº†å¾ˆå¤šäº‹æƒ…ï¼Œå¿ƒæƒ…å¾ˆå¤æ‚", "å¾…å®š", "å›°éš¾"),  # å¤æ‚æƒ…ç»ª
    ("åˆå¼€å¿ƒåˆéš¾è¿‡ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ„Ÿè§‰", "å¾…å®š", "å›°éš¾"),  # æ··åˆæƒ…ç»ª
    ("æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æ„Ÿè§‰ï¼Œå°±æ˜¯å¾ˆå¹³é™", "å¹³é™", "ä¸­ç­‰"),
    
    # éšå«æƒ…ç»ª
    ("æœ€è¿‘æ€»æ˜¯å¤±çœ ï¼Œèº«ä½“ä¹Ÿæ„Ÿè§‰å¾ˆç´¯", "ç–²æƒ«", "ä¸­ç­‰"),
    ("è™½ç„¶è¡¨é¢å¹³é™ï¼Œä½†å†…å¿ƒè¿˜æ˜¯æœ‰ç‚¹ä¸å®‰", "ç„¦è™‘", "å›°éš¾"),
    
    # è´Ÿé¢æƒ…ç»ª
    ("è¢«äººè¯¯è§£äº†ï¼ŒçœŸçš„å¾ˆç”Ÿæ°”", "æ„¤æ€’", "ç®€å•"),
    ("æ„Ÿè§‰è‡ªå·±è¢«æŠ›å¼ƒäº†ï¼Œå¾ˆéš¾è¿‡", "éš¾è¿‡", "ç®€å•"),
    
    # æ­£é¢æƒ…ç»ª
    ("æœŸå¾…æ˜å¤©çš„æ—…è¡Œï¼Œæ„Ÿè§‰å¾ˆå…´å¥‹", "å…´å¥‹", "ç®€å•"),
    ("å¸Œæœ›è¿™æ¬¡èƒ½æˆåŠŸï¼ŒçœŸçš„å¾ˆæœŸå¾…", "æœŸå¾…", "ç®€å•"),
    
    # è½¬æŠ˜å¥å¼æµ‹è¯•
    ("è™½ç„¶å¾ˆç´¯ï¼Œä½†æ˜¯æ„Ÿè§‰å¾ˆå……å®", "å¼€å¿ƒ", "ä¸­ç­‰"),  # è½¬æŠ˜åæ˜¯æƒ…ç»ªï¼ˆå……å®ï¼‰â†’ å¼€å¿ƒ
    ("è™½ç„¶æœ‰ç‚¹éš¾è¿‡ï¼Œä½†è¿˜æ˜¯è¦åšæŒä¸‹å»", "éš¾è¿‡", "ä¸­ç­‰"),  # è½¬æŠ˜åæ˜¯è¡Œä¸ºï¼ˆåšæŒï¼‰â†’ è¯†åˆ«è½¬æŠ˜å‰çš„æƒ…ç»ªï¼šéš¾è¿‡
    ("è™½ç„¶è¡¨é¢å¹³é™ï¼Œä½†å†…å¿ƒè¿˜æ˜¯æœ‰ç‚¹ä¸å®‰", "ç„¦è™‘", "å›°éš¾"),  # è½¬æŠ˜åæ˜¯æƒ…ç»ªï¼ˆä¸å®‰ï¼‰â†’ ç„¦è™‘
    ("å°½ç®¡å·¥ä½œå¾ˆè¾›è‹¦ï¼Œä½†è¿˜æ˜¯å¾ˆæœ‰æˆå°±æ„Ÿ", "å¼€å¿ƒ", "ä¸­ç­‰"),  # è½¬æŠ˜åæ˜¯æƒ…ç»ªï¼ˆæˆå°±æ„Ÿï¼‰â†’ å¼€å¿ƒ
    ("å³ä½¿å¾ˆç´¯ï¼Œä¹Ÿè§‰å¾—å¾ˆå€¼å¾—", "å¼€å¿ƒ", "ä¸­ç­‰"),  # è½¬æŠ˜åæ˜¯æƒ…ç»ªï¼ˆå€¼å¾—ï¼‰â†’ å¼€å¿ƒ
    ("è™½ç„¶é‡åˆ°å›°éš¾ï¼Œä½†æ˜¯æˆ‘ä¼šå…‹æœçš„", "æœŸå¾…", "ä¸­ç­‰"),  # è½¬æŠ˜åæ˜¯è¡Œä¸ºï¼ˆå…‹æœï¼‰â†’ è¯†åˆ«ä¸ºæœŸå¾…ï¼ˆç§¯ææ€åº¦ï¼‰
    ("è™½ç„¶å¾ˆç„¦è™‘ï¼Œä½†è¿˜æ˜¯ä¼šåŠªåŠ›é¢å¯¹", "ç„¦è™‘", "å›°éš¾"),  # è½¬æŠ˜åæ˜¯è¡Œä¸ºï¼ˆé¢å¯¹ï¼‰â†’ è¯†åˆ«è½¬æŠ˜å‰çš„æƒ…ç»ªï¼šç„¦è™‘
    ("è™½ç„¶ä»Šå¤©ä¸‹é›¨ï¼Œä½†å¿ƒæƒ…è¿˜æ˜¯å¾ˆå¥½", "å¼€å¿ƒ", "ä¸­ç­‰"),  # è½¬æŠ˜åæ˜¯æƒ…ç»ªï¼ˆå¾ˆå¥½ï¼‰â†’ å¼€å¿ƒ
    
    # è¯­æ°”è¯æµ‹è¯•
    ("ä»Šå¤©çœŸçš„å¤ªå¥½å•¦ï¼", "å¼€å¿ƒ", "ç®€å•"),  # è¯­æ°”è¯"å•¦"å’Œå¼ºåº¦è¯"çœŸçš„"ã€"å¤ª" â†’ å¼ºçƒˆçš„å¼€å¿ƒ
    ("æˆ‘å¥½éš¾è¿‡å•Š...", "éš¾è¿‡", "ç®€å•"),  # è¯­æ°”è¯"å•Š"å’Œå¼ºåº¦è¯"å¥½" â†’ è¾ƒå¼ºçš„éš¾è¿‡
    ("å¤ªç„¦è™‘äº†...", "ç„¦è™‘", "ç®€å•"),  # å¼ºåº¦è¯"å¤ª" â†’ å¾ˆå¼ºçš„ç„¦è™‘
    ("ç‰¹åˆ«æ„ŸåŠ¨å‘¢ï¼", "æ„ŸåŠ¨", "ç®€å•"),  # å¼ºåº¦è¯"ç‰¹åˆ«"å’Œè¯­æ°”è¯"å‘¢" â†’ å¼ºçƒˆçš„æ„ŸåŠ¨
    ("è¶…çº§å¼€å¿ƒå‘€ï¼", "å¼€å¿ƒ", "ç®€å•"),  # å¼ºåº¦è¯"è¶…çº§"å’Œè¯­æ°”è¯"å‘€" â†’ å¼ºçƒˆçš„å¼€å¿ƒ
    ("çœŸçš„å¾ˆç”Ÿæ°”ï¼", "æ„¤æ€’", "ç®€å•"),  # å¼ºåº¦è¯"çœŸçš„" â†’ å¼ºçƒˆçš„æ„¤æ€’
    ("å¥½æœŸå¾…å•Šï¼", "æœŸå¾…", "ç®€å•"),  # å¼ºåº¦è¯"å¥½"å’Œè¯­æ°”è¯"å•Š" â†’ è¾ƒå¼ºçš„æœŸå¾…
    ("æœ‰ç‚¹ç´¯äº†å‘¢", "ç–²æƒ«", "ç®€å•"),  # å¼ºåº¦è¯"æœ‰ç‚¹"å’Œè¯­æ°”è¯"å‘¢" â†’ è½»åº¦çš„ç–²æƒ«
]


def test_single_case(text, expected, difficulty):
    """æµ‹è¯•å•ä¸ªç”¨ä¾‹ï¼ˆä½¿ç”¨åŸæœ‰æ–¹æ³•ï¼‰"""
    try:
        result = LLMService.analyze_emotion_from_text(text)
        match = result == expected
        icon = "âœ…" if match else "âŒ"
        
        status = "æ­£ç¡®" if match else "é”™è¯¯"
        color = "ç»¿è‰²" if match else "çº¢è‰²"
        
        print(f"{icon} [{difficulty:^4}] {status:^4} | æ–‡æœ¬: {text[:40]:<40} | æœŸæœ›: {expected:<6} | å®é™…: {result:<6}")
        
        return match
    except Exception as e:
        print(f"âŒ [é”™è¯¯] æµ‹è¯•å¤±è´¥ | æ–‡æœ¬: {text[:40]} | é”™è¯¯: {str(e)[:30]}")
        return False


def test_all_cases():
    """æµ‹è¯•æ‰€æœ‰ç”¨ä¾‹"""
    print("=" * 100)
    print("DeepSeek æƒ…ç»ªè¯†åˆ«å‡†ç¡®åº¦æµ‹è¯•")
    print("=" * 100)
    print()
    
    results = {
        'total': 0,
        'correct': 0,
        'wrong': 0,
        'by_difficulty': {
            'ç®€å•': {'total': 0, 'correct': 0},
            'ä¸­ç­‰': {'total': 0, 'correct': 0},
            'å›°éš¾': {'total': 0, 'correct': 0}
        }
    }
    
    print(f"{'éš¾åº¦':^6} | {'çŠ¶æ€':^6} | {'æ–‡æœ¬å†…å®¹':<40} | {'æœŸæœ›':<6} | {'å®é™…':<6}")
    print("-" * 100)
    
    for text, expected, difficulty in TEST_CASES:
        results['total'] += 1
        results['by_difficulty'][difficulty]['total'] += 1
        
        match = test_single_case(text, expected, difficulty)
        
        if match:
            results['correct'] += 1
            results['by_difficulty'][difficulty]['correct'] += 1
        else:
            results['wrong'] += 1
    
    print()
    print("=" * 100)
    print("æµ‹è¯•ç»“æœç»Ÿè®¡")
    print("=" * 100)
    
    # æ€»ä½“å‡†ç¡®åº¦
    accuracy = (results['correct'] / results['total'] * 100) if results['total'] > 0 else 0
    print(f"\næ€»ä½“å‡†ç¡®åº¦: {results['correct']}/{results['total']} = {accuracy:.2f}%")
    
    # æŒ‰éš¾åº¦ç»Ÿè®¡
    print(f"\næŒ‰éš¾åº¦ç»Ÿè®¡:")
    for difficulty in ['ç®€å•', 'ä¸­ç­‰', 'å›°éš¾']:
        diff_results = results['by_difficulty'][difficulty]
        if diff_results['total'] > 0:
            diff_accuracy = (diff_results['correct'] / diff_results['total'] * 100)
            print(f"  {difficulty:^6}: {diff_results['correct']}/{diff_results['total']} = {diff_accuracy:.2f}%")
    
    # é”™è¯¯åˆ†æ
    if results['wrong'] > 0:
        print(f"\nâŒ é”™è¯¯ç”¨ä¾‹ ({results['wrong']} ä¸ª):")
        for text, expected, difficulty in TEST_CASES:
            result = LLMService.analyze_emotion_from_text(text)
            if result != expected:
                print(f"  æ–‡æœ¬: {text[:50]}...")
                print(f"  æœŸæœ›: {expected}, å®é™…: {result}")
                print()
    
    return results


def test_custom_text(text):
    """æµ‹è¯•è‡ªå®šä¹‰æ–‡æœ¬"""
    print(f"\næµ‹è¯•æ–‡æœ¬: {text}")
    print("-" * 80)
    
    result = LLMService.analyze_emotion_from_text(text)
    print(f"è¯†åˆ«ç»“æœ: {result}")
    
    # åŒæ—¶æ˜¾ç¤ºå…³é”®è¯åŒ¹é…ç»“æœï¼ˆå¯¹æ¯”ï¼‰
    keyword_result = LLMService._match_emotion_by_keywords(text)
    print(f"å…³é”®è¯åŒ¹é…: {keyword_result}")
    
    if result == keyword_result:
        print("âœ… DeepSeekå’Œå…³é”®è¯åŒ¹é…ç»“æœä¸€è‡´")
    else:
        print("âš ï¸  DeepSeekå’Œå…³é”®è¯åŒ¹é…ç»“æœä¸ä¸€è‡´")


def benchmark_performance():
    """æ€§èƒ½åŸºå‡†æµ‹è¯•"""
    import time
    
    print("\n" + "=" * 80)
    print("æ€§èƒ½åŸºå‡†æµ‹è¯•")
    print("=" * 80)
    
    # é€‰æ‹©å‡ ä¸ªæµ‹è¯•ç”¨ä¾‹
    test_samples = TEST_CASES[:5]
    
    times = []
    for text, expected, difficulty in test_samples:
        start_time = time.time()
        result = LLMService.analyze_emotion_from_text(text)
        elapsed = time.time() - start_time
        times.append(elapsed)
        print(f"æ–‡æœ¬: {text[:30]:<30} | è€—æ—¶: {elapsed:.2f}s | ç»“æœ: {result}")
    
    if times:
        avg_time = sum(times) / len(times)
        print(f"\nå¹³å‡è€—æ—¶: {avg_time:.2f}s")
        print(f"æœ€å¿«: {min(times):.2f}s")
        print(f"æœ€æ…¢: {max(times):.2f}s")


def test_enhanced_single_case(text, expected, difficulty):
    """æµ‹è¯•å¢å¼ºç‰ˆå•ä¸ªç”¨ä¾‹ï¼ˆä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºï¼‰"""
    try:
        result = LLMService.analyze_emotion_enhanced(text)
        if result is None:
            print(f"âŒ æ–‡æœ¬: {text[:50]}...")
            print(f"   ç»“æœ: None")
            return False, None
        
        label = result.get('label')
        match = label == expected
        icon = "âœ…" if match else "âŒ"
        
        status = "æ­£ç¡®" if match else "é”™è¯¯"
        score = result.get('score', 0.0)
        confidence = result.get('confidence', 0.0)
        intensity = result.get('intensity', 0.0)
        method = result.get('method', 'unknown')
        
        print(f"{icon} {status} ({difficulty})")
        print(f"   æ–‡æœ¬: {text[:50]}...")
        print(f"   æœŸæœ›: {expected}")
        print(f"   å®é™…: {label}")
        if not match:
            print(f"   è¯¦ç»†: score={score:.2f}, confidence={confidence:.2f}, intensity={intensity:.2f}, method={method}")
        
        return match, result
    except Exception as e:
        print(f"âŒ é”™è¯¯ ({difficulty})")
        print(f"   æ–‡æœ¬: {text[:50]}...")
        print(f"   é”™è¯¯: {str(e)}")
        return False, None


def test_batch_analysis():
    """æµ‹è¯•æ‰¹é‡åˆ†æåŠŸèƒ½"""
    print("\n" + "="*80)
    print("ğŸ“Š æµ‹è¯•æ‰¹é‡æƒ…ç»ªåˆ†æ")
    print("="*80)
    
    test_texts = [
        "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œå¿ƒæƒ…ä¹Ÿä¸é”™ï¼",
        "å·¥ä½œå‹åŠ›å¾ˆå¤§ï¼Œæ€»æ˜¯ç¡ä¸å¥½",
        "ä¸€ä¸ªäººåœ¨å®¶ï¼Œæ„Ÿè§‰å¥½å­¤ç‹¬",
        "æ„Ÿè°¢æœ‹å‹çš„å¸®åŠ©ï¼ŒçœŸçš„å¾ˆæ„ŸåŠ¨",
        "ä»Šå¤©è€ƒè¯•è€ƒå¾—å¾ˆå¥½ï¼Œå¤ªå¼€å¿ƒäº†ï¼"
    ]
    
    print(f"\nå¾…åˆ†ææ–‡æœ¬ ({len(test_texts)}æ¡):")
    for i, text in enumerate(test_texts, 1):
        print(f"  {i}. {text}")
    
    print(f"\nå¼€å§‹æ‰¹é‡åˆ†æ...")
    results = LLMService.analyze_emotion_batch(test_texts, max_concurrent=3)
    
    print(f"\nåˆ†æç»“æœ:")
    print("-"*80)
    for i, (text, result) in enumerate(zip(test_texts, results), 1):
        if result:
            label = result.get('label', 'N/A')
            score = result.get('score', 0.0)
            confidence = result.get('confidence', 0.0)
            method = result.get('method', 'unknown')
            print(f"{i}. æ–‡æœ¬: {text[:40]}...")
            print(f"   ç»“æœ: {label} | åˆ†å€¼: {score:.2f} | ç½®ä¿¡åº¦: {confidence:.2f} | æ–¹æ³•: {method}")
        else:
            print(f"{i}. æ–‡æœ¬: {text[:40]}...")
            print(f"   ç»“æœ: åˆ†æå¤±è´¥")
        print()


def test_enhanced_analysis():
    """æµ‹è¯•å¢å¼ºç‰ˆåˆ†æåŠŸèƒ½ï¼ˆç»“æ„åŒ–è¾“å‡ºï¼‰"""
    print("\n" + "="*80)
    print("ğŸš€ æµ‹è¯•å¢å¼ºç‰ˆæƒ…ç»ªåˆ†æï¼ˆç»“æ„åŒ–è¾“å‡ºï¼‰")
    print("="*80)
    
    test_cases = [
        ("ä»Šå¤©çœŸçš„å¤ªå¥½å•¦ï¼", "å¼€å¿ƒ"),
        ("æˆ‘å¥½éš¾è¿‡å•Š...", "éš¾è¿‡"),
        ("å¤ªç„¦è™‘äº†...", "ç„¦è™‘"),
        ("ç‰¹åˆ«æ„ŸåŠ¨å‘¢ï¼", "æ„ŸåŠ¨"),
        ("è™½ç„¶å¾ˆç´¯ï¼Œä½†æ˜¯æ„Ÿè§‰å¾ˆå……å®", "å¼€å¿ƒ"),
    ]
    
    correct_count = 0
    total_count = len(test_cases)
    
    for text, expected in test_cases:
        match, result = test_enhanced_single_case(text, expected, "å¢å¼ºç‰ˆ")
        if match:
            correct_count += 1
        print()
    
    accuracy = (correct_count / total_count * 100) if total_count > 0 else 0
    print("-"*80)
    print(f"å¢å¼ºç‰ˆåˆ†æå‡†ç¡®ç‡: {correct_count}/{total_count} ({accuracy:.1f}%)")
    print("="*80)


if __name__ == '__main__':
    app = create_app()
    with app.app_context():
        import sys
        
        if len(sys.argv) > 1:
            command = sys.argv[1]
            
            if command == 'test':
                # è¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
                test_all_cases()
                
            elif command == 'custom' and len(sys.argv) > 2:
                # æµ‹è¯•è‡ªå®šä¹‰æ–‡æœ¬
                text = ' '.join(sys.argv[2:])
                test_custom_text(text)
                
            elif command == 'benchmark':
                # æ€§èƒ½æµ‹è¯•
                benchmark_performance()
                
            elif command == 'enhanced':
                # å¢å¼ºç‰ˆæµ‹è¯•ï¼ˆç»“æ„åŒ–è¾“å‡ºï¼‰
                test_enhanced_analysis()
                
            elif command == 'batch':
                # æ‰¹é‡æµ‹è¯•
                test_batch_analysis()
                
            else:
                print("ç”¨æ³•:")
                print("  python scripts/test_deepseek_accuracy.py test              # è¿è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹")
                print("  python scripts/test_deepseek_accuracy.py custom <æ–‡æœ¬>      # æµ‹è¯•è‡ªå®šä¹‰æ–‡æœ¬")
                print("  python scripts/test_deepseek_accuracy.py benchmark         # æ€§èƒ½åŸºå‡†æµ‹è¯•")
                print("  python scripts/test_deepseek_accuracy.py enhanced          # å¢å¼ºç‰ˆæµ‹è¯•ï¼ˆç»“æ„åŒ–è¾“å‡ºï¼‰")
                print("  python scripts/test_deepseek_accuracy.py batch             # æ‰¹é‡åˆ†ææµ‹è¯•")
                print("\nç¤ºä¾‹:")
                print("  python scripts/test_deepseek_accuracy.py test")
                print("  python scripts/test_deepseek_accuracy.py custom \"ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½\"")
                print("  python scripts/test_deepseek_accuracy.py benchmark")
                print("  python scripts/test_deepseek_accuracy.py enhanced")
                print("  python scripts/test_deepseek_accuracy.py batch")
        else:
            # é»˜è®¤è¿è¡Œæ‰€æœ‰æµ‹è¯•
            test_all_cases()

